<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Menu Nh√† H√†ng (Mobile)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body { background: #f8f9fa; margin: 0; }
        .menu-header { background: linear-gradient(90deg,#007bff 60%,#00c6ff 100%); color: #fff; border-radius: 0 0 18px 18px; padding: 18px 0 10px 0; text-align: center; margin-bottom: 12px; }
        .menu-header h1 { font-size: 1.4rem; font-weight: 700; margin-bottom: 4px; }
        .menu-header .desc { font-size: 1rem; color: #eaf6ff; }
        .sticky-filter { position: sticky; top: 0; z-index: 100; background: #f8f9fa; padding-top: 8px; }
        .dish-card { box-shadow: 0 2px 12px #0001; border-radius: 18px; background: #fff; margin-bottom: 18px; transition: box-shadow 0.2s, border 0.2s, background 0.2s; border: 2px solid transparent; cursor: pointer; overflow: hidden; }
        .dish-card.selected { border: 2px solid #007bff; background: #eaf6ff; box-shadow: 0 4px 24px #007bff22; }
        .dish-card:active { box-shadow: 0 2px 8px #007bff44; }
        .dish-img { width: 100%; height: 150px; object-fit: cover; border-radius: 16px 16px 0 0; }
        .dish-info { display: flex; flex-direction: column; align-items: center; width: 100%; padding: 0; }
        .dish-title { font-size: 1.1rem; font-weight: 700; color: #007bff; margin-bottom: 2px; max-height: 2.8em; overflow: hidden; text-overflow: ellipsis; white-space: normal; }
        .dish-price { color: #28a745; font-weight: bold; font-size: 1.05rem; margin-bottom: 8px; }
        .qty-group { display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 4px; }
        .qty-btn { width: 32px; height: 32px; border-radius: 50%; border: none; background: #e3f0ff; color: #007bff; font-size: 1.2rem; font-weight: bold; }
        .qty-btn:active { background: #b6e0ff; }
        .qty-input { width: 38px; text-align: center; border: 1px solid #ddd; border-radius: 8px; font-size: 1.1rem; }
        .order-btn { margin: 18px auto 0 auto; display: block; font-size: 1.1rem; padding: 12px 0; border-radius: 20px; width: 96vw; max-width: 98vw; position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%); z-index: 9999; box-shadow: 0 4px 24px #007bff33; }
        .dropdown, .form-select, #search-input { font-size: 1rem; }
        .row.mb-3 { margin-bottom: 10px!important; }
        .dropdown-toggle, .form-select, #search-input { padding: 8px 10px; }
        .modal-content { min-width: 90vw!important; }
        .modal-header, .modal-footer { padding: 10px 16px; }
        .modal-title { font-size: 1.1rem; }
        .btn { font-size: 1rem; }
        .badge { font-size: 0.85em; }
        @media (max-width: 600px) {
            .dish-img { height: 120px; }
            .menu-header { padding: 10px 0 6px 0; }
            .order-btn { font-size: 1rem; padding: 12px 0; }
        }
        .scrolling-tabs { scrollbar-width: thin; }
        .scrolling-tabs::-webkit-scrollbar { height: 4px; background: #eee; }
        .scrolling-tabs::-webkit-scrollbar-thumb { background: #b6e0ff; border-radius: 4px; }
        .dish-grid { display: flex; flex-wrap: wrap; gap: 16px 8px; justify-content: flex-start; }
        .dish-card {
            width: 95vw;
            min-width: 220px;
            max-width: 340px;
            aspect-ratio: 1/1.1;
            min-height: 280px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 16px 8px 12px 8px;
            position: relative;
        }
        .dish-img {
            height: 120px;
            max-width: 100%;
            object-fit: cover;
            border-radius: 12px;
        }
        .dish-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 0;
        }
        .dish-title {
            font-size: 1.08rem;
            font-weight: 600;
            color: #007bff;
            margin: 12px 0 0 0;
            text-align: center;
            word-break: break-word;
            white-space: normal;
            line-height: 1.2;
            min-height: 3.2em;
            max-height: 4.4em;
            overflow: hidden;
        }
        .dish-price { color: #28a745; font-weight: bold; font-size: 1.05rem; text-align: center; word-break: break-word; white-space: normal; line-height: 1.2; min-height: 1.8em; }
        .qty-group { display: flex; align-items: center; justify-content: center; gap: 12px; margin-top: 12px; }
        .qty-btn { width: 28px; height: 28px; border-radius: 50%; border: none; background: #e3f0ff; color: #007bff; font-size: 1.15rem; font-weight: bold; }
        .qty-btn:active { background: #b6e0ff; }
        .qty-input { width: 36px; text-align: center; border: 1px solid #ddd; border-radius: 8px; font-size: 1.08rem; }
        @media (max-width: 600px) {
            .dish-card { width: 32vw; min-width: 100px; max-width: 120px; aspect-ratio: 1/1.6; }
            .dish-img { height: 90px; }
            .dish-title, .dish-price { font-size: 1rem; }
        }
    </style>
</head>
<body>
<div class="menu-header">
    <h1>Menu Nh√† H√†ng</h1>
    <div class="desc">Ch·ªçn m√≥n, tick v√†o m√≥n ƒë·ªÉ ch·ªçn v√† nh·∫•n "G·ª≠i order"!</div>
</div>
<div class="container-fluid px-2">
    <div class="row mb-3 align-items-end gx-1 sticky-filter">
        <div class="col-6">
            <select class="form-select" id="sort-select">
                <option value="">S·∫Øp x·∫øp</option>
                <option value="price-asc">Gi√° tƒÉng d·∫ßn</option>
                <option value="price-desc">Gi√° gi·∫£m d·∫ßn</option>
                <option value="featured">N·ªïi b·∫≠t</option>
                <option value="new">M·ªõi</option>
            </select>
        </div>
        <div class="col-6">
            <input type="text" class="form-control" id="search-input" placeholder="üîç T√¨m m√≥n...">
        </div>
    </div>
    <!-- Tabs lo·∫°i m√≥n -->
    <div id="dish-type-tabs" class="scrolling-tabs" style="overflow-x:auto;white-space:nowrap;padding:0 0 8px 0;margin-bottom:8px;">
        <!-- Tab buttons s·∫Ω ƒë∆∞·ª£c render b·∫±ng JS -->
    </div>
    <div class="row" id="dish-list"></div>
    <button class="btn btn-primary order-btn" id="order-btn">G·ª≠i order</button>
</div>
<!-- Thanh taskbar d∆∞·ªõi c√πng -->
<div id="mobile-taskbar" style="position:fixed;bottom:0;left:0;width:100vw;height:62px;background:#fff;border-radius:18px 18px 0 0;box-shadow:0 -2px 16px #007bff22;z-index:10000;display:flex;align-items:center;justify-content:space-between;padding:0 18px 0 18px;gap:10px;">
    <button class="btn btn-primary" id="taskbar-order-btn" style="height:44px;min-width:110px;font-size:1.05rem;border-radius:16px;box-shadow:0 2px 8px #007bff22;">G·ª≠i order</button>
    <div style="display:flex;gap:12px;">
        <button id="taskbar-staff-btn" style="background:#fff;color:#007bff;border:none;border-radius:50%;width:44px;height:44px;box-shadow:0 2px 8px #e83e8c22;font-size:1.5rem;display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative;">
            <i class="fa-solid fa-user-large"></i>
        </button>
        <button id="taskbar-cart-btn" style="background:#fff;color:#007bff;border:none;border-radius:50%;width:44px;height:44px;box-shadow:0 2px 8px #0003;font-size:1.5rem;display:flex;align-items:center;justify-content:center;cursor:pointer;">
            <i class="fas fa-shopping-cart"></i>
        </button>
        <button id="taskbar-chatbot-btn" style="background:#007bff;color:#fff;border:none;border-radius:50%;width:48px;height:48px;box-shadow:0 2px 8px #0003;font-size:1.7rem;display:flex;align-items:center;justify-content:center;cursor:pointer;">
            <i class="fas fa-comments"></i>
        </button>
    </div>
</div>
<!-- ·∫®n c√°c n√∫t n·ªïi c≈© v√† n√∫t order c≈© -->
<style>
#open-cart-btn, #open-chatbot-btn, #order-btn { display: none !important; }
body { padding-bottom: 80px; }
.qty-group {
    display: flex !important;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-top: 4px;
    visibility: visible !important;
    opacity: 1 !important;
    height: auto !important;
}
.qty-btn, .qty-input {
    display: inline-block !important;
    visibility: visible !important;
    opacity: 1 !important;
}
#taskbar-staff-btn:active {
    background: #ffe6f0;
    box-shadow: 0 2px 8px #e83e8c44;
}
#staff-btn-badge {
    transition: transform 0.2s;
}
#staff-btn-badge[style*="display: block"] {
    transform: scale(1.2);
}
</style>
<!-- Modal chatbot -->
<div class="modal fade" id="chatbotModal" tabindex="-1" aria-labelledby="chatbotModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen m-0" style="max-width:100vw;width:100vw;height:100vh;">
    <div class="modal-content p-0 border-0 shadow-none" style="border-radius:0;overflow:hidden;min-width:100vw;min-height:100vh;background:#fff;">
      <div class="modal-header p-2 border-0" style="background:transparent;position:absolute;top:0;right:0;z-index:10;width:100vw;display:flex;justify-content:flex-end;align-items:flex-start;">
        <button type="button" class="btn btn-light btn-lg d-flex align-items-center justify-content-center" data-bs-dismiss="modal" aria-label="Close" style="font-size:1.5rem;border-radius:50%;width:36px;height:36px;box-shadow:0 2px 8px #0002;display:flex;align-items:center;justify-content:center;"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body p-0" style="background:transparent;height:100vh;width:100vw;overflow:hidden;">
        <iframe id="chatbot-iframe" src="/chatbot-popup" style="width:100vw;height:100vh;border:none;background:transparent;display:block;"></iframe>
      </div>
    </div>
  </div>
</div>
<!-- Icon gi·ªè h√†ng g√≥c ph·∫£i tr√™n -->
<button id="open-cart-btn" style="position:fixed;top:18px;right:18px;z-index:9999;background:#fff;color:#007bff;border:none;border-radius:50%;width:48px;height:48px;box-shadow:0 2px 8px #0003;font-size:1.7rem;display:flex;align-items:center;justify-content:center;cursor:pointer;">
    <i class="fas fa-shopping-cart"></i>
</button>
<!-- Modal gi·ªè h√†ng -->
<div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius:18px;overflow:hidden;min-width:90vw;">
      <div class="modal-header">
        <h5 class="modal-title" id="cartModalLabel">Gi·ªè h√†ng c·ªßa b·∫°n</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0" id="cart-body"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
      </div>
    </div>
  </div>
</div>
<!-- Modal QR chuy·ªÉn kho·∫£n -->
<div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius:18px;overflow:hidden;min-width:90vw;">
      <div class="modal-header">
        <h5 class="modal-title" id="qrModalLabel">Thanh to√°n chuy·ªÉn kho·∫£n</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="qr-modal-body">
        <div class="text-center text-muted">ƒêang l·∫•y m√£ QR...</div>
      </div>
    </div>
  </div>
</div>
<script>
// --- Copy to√†n b·ªô JS t·ª´ menu.html sang mobile_menu.html ƒë·ªÉ m·ªçi ch·ª©c nƒÉng ho·∫°t ƒë·ªông ---
// L·∫•y danh s√°ch m√≥n ƒÉn t·ª´ API
async function fetchDishes() {
    const res = await fetch('/api/dishes');
    return await res.json();
}
let allDishes = [];
let currentType = 'T·∫•t c·∫£';
let currentMeal = 'T·∫•t c·∫£';
let currentRegion = 'T·∫•t c·∫£';
let searchKeyword = '';
let currentSort = '';
let lastDishesJson = '';
function renderDropdowns() {} // Mobile kh√¥ng d√πng dropdown n√¢ng cao
function getAllTypes(dishes) {
    const types = new Set();
    dishes.forEach(d => { if (d.type) types.add(d.type); });
    return Array.from(types);
}
function renderTypeTabs(dishes) {
    const types = getAllTypes(dishes);
    const tabBar = document.getElementById('dish-type-tabs');
    let html = `<button class="btn btn-sm${currentType==='T·∫•t c·∫£'?' btn-primary':' btn-outline-primary'} mx-1 mb-1" onclick="selectTypeTab('T·∫•t c·∫£')">T·∫•t c·∫£</button>`;
    types.forEach(type => {
        html += `<button class="btn btn-sm${currentType===type?' btn-primary':' btn-outline-primary'} mx-1 mb-1" onclick="selectTypeTab('${type.replace(/'/g, '\&#39;')}')">${type}</button>`;
    });
    tabBar.innerHTML = html;
}
function selectTypeTab(type) {
    currentType = type;
    renderTypeTabs(allDishes);
    renderDishes(allDishes);
}
function renderDishes(dishes) {
    const dishList = document.getElementById('dish-list');
    dishList.innerHTML = '';
    let filtered = dishes;
    if (currentType && currentType !== 'T·∫•t c·∫£') {
        filtered = filtered.filter(d => d.dish_type === currentType);
    }
    if (searchKeyword) {
        filtered = filtered.filter(d => d.name.toLowerCase().includes(searchKeyword) || (d.description && d.description.toLowerCase().includes(searchKeyword)));
    }
    if (currentSort === 'price-asc') {
        filtered = filtered.slice().sort((a, b) => (a.price || 0) - (b.price || 0));
    } else if (currentSort === 'price-desc') {
        filtered = filtered.slice().sort((a, b) => (b.price || 0) - (a.price || 0));
    } else if (currentSort === 'featured') {
        filtered = filtered.slice().sort((a, b) => (b.price || 0) - (a.price || 0)).slice(0, 8);
    } else if (currentSort === 'new') {
        filtered = filtered.slice().sort((a, b) => b.name.localeCompare(a.name)).slice(0, 8);
    }
    if (!filtered.length) {
        dishList.innerHTML = '<div class="text-center text-muted py-5">Kh√¥ng t√¨m th·∫•y m√≥n n√†o ph√π h·ª£p.</div>';
        window._currentRenderedDishes = [];
        return;
    }
    window._currentRenderedDishes = filtered;
    // T·∫°o grid
    const grid = document.createElement('div');
    grid.className = 'dish-grid';
    filtered.forEach((dish, idx) => {
        let tagHtml = '';
        if (dish.status === false) {
            tagHtml += '<span class="badge bg-danger position-absolute top-50 start-50 translate-middle">T·∫°m h·∫øt m√≥n</span>';
        }
        const card = document.createElement('div');
        card.className = 'dish-card position-relative' + (dish.status === false ? ' opacity-50' : '');
        card.setAttribute('data-idx', idx);
        card.onclick = function() { toggleSelectDish(idx); };
        card.innerHTML = `
            ${tagHtml}
            <img class="dish-img" src="${dish.image || 'https://via.placeholder.com/400x160?text=No+Image'}" alt="${dish.name}">
            <div class="dish-info">
                <div class="dish-title">${dish.name}</div>
                <div class="dish-price">${dish.price ? dish.price.toLocaleString() + ' ƒë' : ''}</div>
                <div class="qty-group">
                    <button class="qty-btn" type="button" onclick="event.stopPropagation(); changeQty(${idx}, -1)" ${dish.status === false ? 'disabled' : ''}>-</button>
                    <input class="qty-input" type="number" min="1" value="1" id="qty-${idx}" ${dish.status === false ? 'disabled' : ''} onclick="event.stopPropagation();">
                    <button class="qty-btn" type="button" onclick="event.stopPropagation(); changeQty(${idx}, 1)" ${dish.status === false ? 'disabled' : ''}>+</button>
                </div>
            </div>
        `;
        grid.appendChild(card);
    });
    // ƒê√°nh d·∫•u card ƒë√£ ch·ªçn
    (window._selectedDishesIdxs || []).forEach(idx => {
        const card = grid.querySelector(`.dish-card[data-idx='${idx}']`);
        if (card) card.classList.add('selected');
    });
    dishList.appendChild(grid);
}
function changeQty(idx, delta) {
    const input = document.getElementById('qty-' + idx);
    if (!input) return;
    let val = parseInt(input.value) || 1;
    val += delta;
    if (val < 1) val = 1;
    input.value = val;
}
document.getElementById('search-input').addEventListener('input', function(e) {
    searchKeyword = e.target.value.trim().toLowerCase();
    renderDishes(allDishes);
});
document.getElementById('sort-select').addEventListener('change', function(e) {
    currentSort = e.target.value;
    renderDishes(allDishes);
});
document.addEventListener('DOMContentLoaded', async () => {
    const dishes = await fetchDishes();
    allDishes = dishes;
    renderTypeTabs(dishes);
    renderDishes(dishes);
    lastDishesJson = JSON.stringify(dishes);
    setInterval(async () => {
        const dishes = await fetchDishes();
        const newJson = JSON.stringify(dishes);
        if (newJson !== lastDishesJson) {
            allDishes = dishes;
            renderTypeTabs(dishes);
            renderDishes(dishes);
            lastDishesJson = newJson;
        }
    }, 1000);
});
window._selectedDishesIdxs = [];
function toggleSelectDish(idx) {
    if (window._currentRenderedDishes[idx].status === false) return;
    const i = window._selectedDishesIdxs.indexOf(idx);
    if (i === -1) window._selectedDishesIdxs.push(idx);
    else window._selectedDishesIdxs.splice(i, 1);
    renderDishes(allDishes);
    updateOrderBtnPosition();
}
// L·∫•y table_id t·ª´ URL v√† l∆∞u v√†o localStorage
function getTableIdFromUrl() {
    const params = new URLSearchParams(window.location.search);
    return params.get('table_id');
}
const tableId = getTableIdFromUrl();
if (tableId) {
    localStorage.setItem('table_id', tableId);
}
function getTableId() {
    return localStorage.getItem('table_id') || '';
}
// G·ª≠i order
document.getElementById('order-btn').onclick = async function() {
    const selected = [];
    (window._selectedDishesIdxs || []).forEach(idx => {
        const dish = window._currentRenderedDishes[idx];
        const qty = document.getElementById('qty-' + idx) ? parseInt(document.getElementById('qty-' + idx).value) || 1 : 1;
        selected.push({ name: dish.name, quantity: qty });
    });
    if (selected.length === 0) {
        alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt m√≥n!');
        return;
    }
    const res = await fetch('/api/order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items: selected, table_id: getTableId() })
    });
    if (res.ok) {
        alert('ƒê√£ th√™m v√†o h√≥a ƒë∆°n! B·∫°n c√≥ th·ªÉ m·ªü chatbot ƒë·ªÉ chat ho·∫∑c xem h√≥a ƒë∆°n.');
        window._selectedDishesIdxs = [];
        renderDishes(allDishes);
    } else {
        alert('C√≥ l·ªói khi g·ª≠i order!');
    }
};
document.getElementById('chatbotModal').addEventListener('hidden.bs.modal', function () {
    updateOrderBtnPosition(); // Hi·ªán l·∫°i n√∫t n·∫øu c√≥ m√≥n ƒë∆∞·ª£c ch·ªçn
});
let cartPollingInterval = null;
document.getElementById('open-cart-btn').onclick = async function() {
    await loadAndShowCartModal();
};
async function loadAndShowCartModal() {
    const res = await fetch('/api/cart', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ table_id: getTableId() })
    });
    const data = await res.json();
    renderCart(data);
    var modal = new bootstrap.Modal(document.getElementById('cartModal'));
    modal.show();
    if (cartPollingInterval) clearInterval(cartPollingInterval);
    cartPollingInterval = setInterval(async () => {
        if (!document.getElementById('cartModal').classList.contains('show')) {
            clearInterval(cartPollingInterval);
            cartPollingInterval = null;
            return;
        }
        const res = await fetch('/api/cart', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ table_id: getTableId() })
        });
        const data = await res.json();
        renderCart(data);
    }, 3000);
}
document.getElementById('cartModal').addEventListener('hidden.bs.modal', function () {
    if (cartPollingInterval) clearInterval(cartPollingInterval);
    cartPollingInterval = null;
});
let lastOrderStatusMap = {};
function renderCart(cartData) {
    if (document.activeElement && document.activeElement.classList.contains('note-input-focus')) {
        return;
    }
    const cartBody = document.getElementById('cart-body');
    const orders = cartData.orders || [];
    let qrJustPaid = false;
    orders.forEach(cart => {
        const prevStatus = lastOrderStatusMap[cart.order_id];
        if ((cart.status === 'paid' || cart.status === 'ƒê√£ thanh to√°n') && prevStatus && prevStatus !== 'paid' && prevStatus !== 'ƒê√£ thanh to√°n') {
            const qrModal = document.getElementById('qrModal');
            if (qrModal) {
                const isOpen = qrModal.classList.contains('show') || qrModal.getAttribute('aria-modal') === 'true' || qrModal.style.display === 'block';
                if (isOpen) {
                    let modal = bootstrap.Modal.getInstance(qrModal);
                    if (!modal) modal = new bootstrap.Modal(qrModal);
                    modal.hide();
                    qrJustPaid = true;
                }
            }
        }
    });
    orders.forEach(cart => {
        lastOrderStatusMap[cart.order_id] = cart.status;
    });
    if (!orders.length) {
        cartBody.innerHTML = '<div class="p-4 text-center text-muted">B·∫°n ch∆∞a c√≥ h√≥a ƒë∆°n n√†o.</div>';
        return;
    }
    let html = '';
    let totalAll = 0;
    orders.forEach((cart, idx) => {
        html += `<div class='card mb-4 shadow-sm'>`;
        html += `<div class='card-header d-flex justify-content-between align-items-center'>`;
        html += `<span><b>H√≥a ƒë∆°n #${idx + 1}</b> (${cart.created_at || ''})</span>`;
        html += `<span class='badge bg-${getStatusColor(cart.status)}'>${getStatusText(cart.status)}</span>`;
        html += `</div><div class='card-body p-0'>`;
        html += '<table class="table table-bordered mb-0"><thead><tr><th>M√≥n</th><th>SL</th><th>Gi√°</th><th>Th√†nh ti·ªÅn</th><th>Ghi ch√∫</th><th></th></tr></thead><tbody>';
        cart.items.forEach(item => {
            html += `<tr><td>${item.dish}</td><td>${item.quantity}</td><td>${item.unit_price ? item.unit_price.toLocaleString() + ' ƒë' : ''}</td><td><b>${item.amount.toLocaleString()} ƒë</b></td>`;
            html += '<td>';
            if (!cart.status || cart.status === 'pending') {
                html += `<input type='text' class='form-control form-control-sm note-input-focus' style='min-width:90px;max-width:180px;display:inline-block' value="${item.note ? item.note.replace(/"/g, '&quot;') : ''}" onfocus="this.classList.add('note-input-focus')" onblur="this.classList.remove('note-input-focus'); updateNote('${cart.order_id}','${item.dish.replace(/'/g, '\&#39;').replace(/"/g, '&quot;')}', this.value)" placeholder='Ghi ch√∫...'>`;
            } else {
                html += `<span>${item.note || ''}</span>`;
            }
            html += '</td>';
            html += '<td>';
            if (!cart.status || cart.status === 'pending') {
                html += `<button class='btn btn-sm btn-danger' onclick='removeCartItem("${cart.order_id}", "${item.dish.replace(/"/g, '&quot;')}")'><i class="fas fa-trash"></i></button>`;
            }
            html += `</td></tr>`;
        });
        html += '</tbody></table>';
        html += `<div class="p-3 text-end"><b>T·ªïng c·ªông: ${cart.total ? cart.total.toLocaleString() : 0} ƒë</b></div>`;
        totalAll += cart.total || 0;
        if (cart.status === 'confirmed') {
            html += `<div class='alert alert-success m-3 text-center'>ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c g·ª≠i cho nh√† h√†ng. ƒêang ch·ªù b·∫øp x√°c nh·∫≠n!</div>`;
            html += `<div class='text-center mb-3'><button class='btn btn-success' disabled>ƒê√£ g·ª≠i nh√† h√†ng</button></div>`;
        } else if (cart.status === 'in_progress') {
            html += `<div class='alert alert-info m-3 text-center'>Nh√† h√†ng ƒë√£ x√°c nh·∫≠n m√≥n ƒÉn, b·∫°n ch·ªù trong gi√¢y l√°t nh√©!</div>`;
            html += `<div class='text-center mb-3'><button class='btn btn-info' disabled>ƒêang l√†m m√≥n</button></div>`;
        } else if (cart.status === 'done') {
            html += `<div class='alert alert-primary m-3 text-center'>M√≥n ƒÉn ƒë√£ ho√†n th√†nh! Ch√∫c b·∫°n ngon mi·ªáng.</div>`;
            html += `<div class='text-center mb-3'><button class='btn btn-primary' disabled>ƒê√£ xong</button></div>`;
        } else if (cart.status === 'paid' || cart.status === 'ƒê√£ thanh to√°n') {
            html += `<div class='alert alert-success m-3 text-center'><b>Nh√† h√†ng ƒë√£ x√°c nh·∫≠n chuy·ªÉn kho·∫£n th√†nh c√¥ng! C·∫£m ∆°n b·∫°n.</b></div>`;
            html += `<div class='text-center mb-3'><button class='btn btn-success' disabled>ƒê√£ thanh to√°n</button></div>`;
        } else {
            html += `<div class='text-center mb-3'><button class='btn btn-success' onclick='confirmCart("${cart.order_id}")'>X√°c nh·∫≠n g·ª≠i m√≥n cho nh√† h√†ng</button></div>`;
        }
        html += `</div></div>`;
    });
    html += `<div class="alert alert-info text-end mb-0"><b>üí∞ T·ªïng h√≥a ƒë∆°n (t·∫•t c·∫£): ${totalAll.toLocaleString()} ƒë</b></div>`;
    cartBody.innerHTML = html;
    if (qrJustPaid) {
        setTimeout(() => { alert('Nh√† h√†ng ƒë√£ x√°c nh·∫≠n chuy·ªÉn kho·∫£n th√†nh c√¥ng!'); }, 300);
    }
}function getStatusColor(status) {
    if (status === 'confirmed') return 'success';
    if (status === 'in_progress') return 'info';
    if (status === 'done') return 'primary';
    if (status === 'paid' || status === 'ƒê√£ thanh to√°n') return 'danger';
    return 'secondary';
}function getStatusText(status) {
    if (status === 'confirmed') return 'ƒê√£ g·ª≠i b·∫øp';
    if (status === 'in_progress') return 'ƒêang l√†m';
    if (status === 'done') return 'ƒê√£ xong';
    if (status === 'paid' || status === 'ƒê√£ thanh to√°n') return 'ƒê√£ thanh to√°n';
    return 'Ch∆∞a ch·ªët';
}
async function removeCartItem(orderId, dishName) {
    if (!confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a m√≥n n√†y kh·ªèi h√≥a ƒë∆°n?')) return;
    const res = await fetch('/api/cart/remove_item', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ dish_name: dishName, order_id: orderId, table_id: getTableId() })
    });
    if (res.ok) {
        const cartRes = await fetch('/api/cart', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ table_id: getTableId() })
        });
        const cartData = await cartRes.json();
        renderCart(cartData);
    } else {
        alert('C√≥ l·ªói khi x√≥a m√≥n!');
    }
}
async function confirmCart(orderId) {
    if (!confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën g·ª≠i ƒë∆°n n√†y cho nh√† h√†ng? Sau khi x√°c nh·∫≠n s·∫Ω kh√¥ng th·ªÉ s·ª≠a/x√≥a m√≥n!')) return;
    const res = await fetch('/api/cart/confirm', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ order_id: orderId, table_id: getTableId() })
    });
    if (res.ok) {
        alert('ƒê√£ g·ª≠i ƒë∆°n cho nh√† h√†ng!');
        const cartRes = await fetch('/api/cart', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ table_id: getTableId() })
        });
        const cartData = await cartRes.json();
        renderCart(cartData);
    } else {
        alert('C√≥ l·ªói khi x√°c nh·∫≠n ƒë∆°n!');
    }
}
async function updateNote(orderId, dishName, note) {
    const res = await fetch('/api/cart/update_note', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ order_id: orderId, dish_name: dishName, note: note, table_id: getTableId() })
    });
    if (!res.ok) {
        alert('C√≥ l·ªói khi l∆∞u ghi ch√∫!');
    }
}
(function addPayQRButton() {
    const cartModalFooter = document.querySelector('#cartModal .modal-footer');
    if (cartModalFooter && !document.getElementById('pay-qr-btn')) {
        const btn = document.createElement('button');
        btn.className = 'btn btn-warning';
        btn.id = 'pay-qr-btn';
        btn.innerHTML = '<i class="fas fa-qrcode"></i> Thanh to√°n chuy·ªÉn kho·∫£n';
        btn.onclick = showQRModal;
        cartModalFooter.insertBefore(btn, cartModalFooter.firstChild);
    }
})();
async function showQRModal() {
    const qrBody = document.getElementById('qr-modal-body');
    qrBody.innerHTML = '<div class="text-center text-muted">ƒêang l·∫•y m√£ QR...</div>';
    var modal = new bootstrap.Modal(document.getElementById('qrModal'));
    modal.show();
    try {
        const res = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: 'chuy·ªÉn kho·∫£n' })
        });
        const data = await res.json();
        qrBody.innerHTML = data.response || '<div class="text-danger">Kh√¥ng l·∫•y ƒë∆∞·ª£c m√£ QR!</div>';
        // Th√™m n√∫t t·∫£i QR n·∫øu c√≥ ·∫£nh QR
        setTimeout(() => {
            const img = qrBody.querySelector('img');
            if (img) {
                // T·∫°o container flex cho ·∫£nh v√† n√∫t
                let flexDiv = document.createElement('div');
                flexDiv.style.display = 'flex';
                flexDiv.style.alignItems = 'center';
                flexDiv.style.justifyContent = 'center';
                flexDiv.style.gap = '16px';
                // Di chuy·ªÉn ·∫£nh v√†o container
                img.parentNode.insertBefore(flexDiv, img);
                flexDiv.appendChild(img);
                // T·∫°o n√∫t t·∫£i
                let downloadBtn = document.createElement('button');
                downloadBtn.className = 'btn btn-outline-primary';
                downloadBtn.innerHTML = '<i class="fas fa-download"></i> T·∫£i m√£ QR';
                downloadBtn.onclick = async function() {
                    try {
                        const response = await fetch(img.src, {mode: 'cors'});
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = 'qr-code.png';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(url);
                    } catch (e) {
                        alert('Kh√¥ng th·ªÉ t·∫£i ·∫£nh QR. B·∫°n c√≥ th·ªÉ nh·∫•n gi·ªØ v√†o ·∫£nh ƒë·ªÉ l∆∞u v·ªÅ m√°y!');
                    }
                };
                flexDiv.appendChild(downloadBtn);
            }
        }, 100);
    } catch (e) {
        qrBody.innerHTML = '<div class="text-danger">C√≥ l·ªói khi l·∫•y m√£ QR!</div>';
    }
}
const style = document.createElement('style');
style.innerHTML = `
#order-btn.fixed-order-btn {
  position: fixed;
  left: 50%;
  bottom: 32px;
  transform: translateX(-50%);
  z-index: 9999;
  width: 90vw;
  max-width: 420px;
  box-shadow: 0 4px 24px #007bff33;
  display: block;
}
@media (max-width: 600px) {
  #order-btn.fixed-order-btn {
    width: 96vw;
    max-width: 98vw;
    font-size: 1.1rem;
    padding: 12px 0;
  }
}`;
document.head.appendChild(style);
function updateOrderBtnPosition() {
    const btn = document.getElementById('order-btn');
    const anyChecked = (window._selectedDishesIdxs || []).length > 0;
    if (anyChecked) {
        btn.classList.add('fixed-order-btn');
        btn.style.display = 'block';
    } else {
        btn.classList.remove('fixed-order-btn');
        btn.style.display = '';
    }
}
const origRenderDishes = renderDishes;
renderDishes = function() {
    origRenderDishes.apply(this, arguments);
    setTimeout(() => {
        document.querySelectorAll('.select-checkbox').forEach(cb => {
            cb.removeEventListener('change', updateOrderBtnPosition);
            cb.addEventListener('change', updateOrderBtnPosition);
        });
        updateOrderBtnPosition();
    }, 0);
};
document.getElementById('taskbar-cart-btn').onclick = async function() {
    await loadAndShowCartModal();
};
document.getElementById('taskbar-chatbot-btn').onclick = function() {
    var modal = new bootstrap.Modal(document.getElementById('chatbotModal'));
    modal.show();
    // ·∫®n taskbar khi m·ªü chatbot
    const mobileTaskbar = document.getElementById('mobile-taskbar');
    if (mobileTaskbar) mobileTaskbar.style.display = 'none';
};
document.getElementById('chatbotModal').addEventListener('hidden.bs.modal', function () {
    // Hi·ªán l·∫°i taskbar khi ƒë√≥ng chatbot
    const mobileTaskbar = document.getElementById('mobile-taskbar');
    if (mobileTaskbar) mobileTaskbar.style.display = 'flex';
});
document.getElementById('taskbar-order-btn').onclick = async function() {
    const selected = [];
    (window._selectedDishesIdxs || []).forEach(idx => {
        const dish = window._currentRenderedDishes[idx];
        const qty = document.getElementById('qty-' + idx) ? parseInt(document.getElementById('qty-' + idx).value) || 1 : 1;
        selected.push({ name: dish.name, quantity: qty });
    });
    if (selected.length === 0) {
        alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt m√≥n!');
        return;
    }
    const res = await fetch('/api/order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items: selected, table_id: getTableId() })
    });
    if (res.ok) {
        alert('ƒê√£ th√™m v√†o h√≥a ƒë∆°n! B·∫°n c√≥ th·ªÉ m·ªü chatbot ƒë·ªÉ chat ho·∫∑c xem h√≥a ƒë∆°n.');
        window._selectedDishesIdxs = [];
        renderDishes(allDishes);
    } else {
        alert('C√≥ l·ªói khi g·ª≠i order!');
    }
};
// ·∫®n/hi·ªán n√∫t order tr√™n taskbar tu·ª≥ m√≥n ƒë∆∞·ª£c ch·ªçn
function updateOrderBtnPosition() {
    const btn = document.getElementById('taskbar-order-btn');
    const anyChecked = (window._selectedDishesIdxs || []).length > 0;
    btn.style.visibility = anyChecked ? 'visible' : 'hidden';
}
// ·∫®n taskbar khi m·ªü gi·ªè h√†ng, hi·ªán l·∫°i khi ƒë√≥ng gi·ªè h√†ng
const mobileTaskbar = document.getElementById('mobile-taskbar');
document.getElementById('cartModal').addEventListener('show.bs.modal', function () {
    if (mobileTaskbar) mobileTaskbar.style.display = 'none';
});
document.getElementById('cartModal').addEventListener('hidden.bs.modal', function () {
    if (mobileTaskbar) mobileTaskbar.style.display = 'flex';
});
document.getElementById('taskbar-staff-btn').onclick = async function() {
    if (!confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën g·ªçi nh√¢n vi√™n kh√¥ng?')) return;
    const tableId = getTableId();
    const res = await fetch('/api/call_staff', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ table_id: tableId })
    });
    if (res.ok) {
        alert('ƒê√£ g·ª≠i y√™u c·∫ßu g·ªçi nh√¢n vi√™n! Nh√¢n vi√™n s·∫Ω ƒë·∫øn h·ªó tr·ª£ b·∫°n trong gi√¢y l√°t.');
    } else {
        alert('C√≥ l·ªói khi g·ª≠i y√™u c·∫ßu g·ªçi nh√¢n vi√™n!');
    }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html> 


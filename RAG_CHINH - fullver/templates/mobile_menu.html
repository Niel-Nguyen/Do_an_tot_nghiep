<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Menu Nh√† H√†ng (Mobile)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body { background: #f8f9fa; margin: 0; }
        .menu-header { background: linear-gradient(90deg,#007bff 60%,#00c6ff 100%); color: #fff; border-radius: 0 0 18px 18px; padding: 18px 0 10px 0; text-align: center; margin-bottom: 12px; position: relative; }
        .menu-header h1 { font-size: 1.4rem; font-weight: 700; margin-bottom: 4px; }
        .menu-header .desc { font-size: 1rem; color: #eaf6ff; }
        .sticky-filter { position: sticky; top: 0; z-index: 100; background: #f8f9fa; padding-top: 8px; }
        .dish-card { box-shadow: 0 2px 12px #0001; border-radius: 18px; background: #fff; margin-bottom: 18px; transition: box-shadow 0.2s, border 0.2s, background 0.2s; border: 2px solid transparent; cursor: pointer; overflow: hidden; }
        .dish-card.selected { border: 2px solid #007bff; background: #eaf6ff; box-shadow: 0 4px 24px #007bff22; }
        .dish-card:active { box-shadow: 0 2px 8px #007bff44; }
        .dish-img { width: 100%; height: 150px; object-fit: cover; border-radius: 16px 16px 0 0; }
        .dish-info { display: flex; flex-direction: column; align-items: center; width: 100%; padding: 0; }
        .dish-title { font-size: 1.1rem; font-weight: 700; color: #007bff; margin-bottom: 2px; max-height: 2.8em; overflow: hidden; text-overflow: ellipsis; white-space: normal; }
        .dish-price { color: #28a745; font-weight: bold; font-size: 1.05rem; margin-bottom: 8px; }
        .qty-group { display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 4px; }
        .qty-btn { width: 32px; height: 32px; border-radius: 50%; border: none; background: #e3f0ff; color: #007bff; font-size: 1.2rem; font-weight: bold; }
        .qty-btn:active { background: #b6e0ff; }
        .qty-input { width: 38px; text-align: center; border: 1px solid #ddd; border-radius: 8px; font-size: 1.1rem; }
        .order-btn { margin: 18px auto 0 auto; display: block; font-size: 1.1rem; padding: 12px 0; border-radius: 20px; width: 96vw; max-width: 98vw; position: fixed; left: 50%; bottom: 18px; transform: translateX(-50%); z-index: 9999; box-shadow: 0 4px 24px #007bff33; }
        .dropdown, .form-select, #search-input { font-size: 1rem; }
        .row.mb-3 { margin-bottom: 10px!important; }
        .dropdown-toggle, .form-select, #search-input { padding: 8px 10px; }
        .modal-content { min-width: 90vw!important; }
        .modal-header, .modal-footer { padding: 10px 16px; }
        .modal-title { font-size: 1.1rem; }
        .btn { font-size: 1rem; }
        .badge { font-size: 0.85em; }
        @media (max-width: 600px) {
            .dish-img { height: 120px; }
            .menu-header { padding: 10px 0 6px 0; }
            .order-btn { font-size: 1rem; padding: 12px 0; }
        }
        .scrolling-tabs { scrollbar-width: thin; }
        .scrolling-tabs::-webkit-scrollbar { height: 4px; background: #eee; }
        .scrolling-tabs::-webkit-scrollbar-thumb { background: #b6e0ff; border-radius: 4px; }
        .dish-grid { display: flex; flex-wrap: wrap; gap: 16px 8px; justify-content: flex-start; }
        .dish-card {
            width: 95vw;
            min-width: 220px;
            max-width: 340px;
            aspect-ratio: 1/1.1;
            min-height: 280px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 16px 8px 12px 8px;
            position: relative;
        }
        .dish-img {
            height: 120px;
            max-width: 100%;
            object-fit: cover;
            border-radius: 12px;
        }
        .dish-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 0;
        }
        .dish-title {
            font-size: 1.08rem;
            font-weight: 600;
            color: #007bff;
            margin: 12px 0 0 0;
            text-align: center;
            word-break: break-word;
            white-space: normal;
            line-height: 1.2;
            min-height: 3.2em;
            max-height: 4.4em;
            overflow: hidden;
        }
        .dish-price { color: #28a745; font-weight: bold; font-size: 1.05rem; text-align: center; word-break: break-word; white-space: normal; line-height: 1.2; min-height: 1.8em; }
        .qty-group { display: flex; align-items: center; justify-content: center; gap: 12px; margin-top: 12px; }
        .qty-btn { width: 28px; height: 28px; border-radius: 50%; border: none; background: #e3f0ff; color: #007bff; font-size: 1.15rem; font-weight: bold; }
        .qty-btn:active { background: #b6e0ff; }
        .qty-input { width: 36px; text-align: center; border: 1px solid #ddd; border-radius: 8px; font-size: 1.08rem; }
        @media (max-width: 600px) {
            .dish-card { width: 32vw; min-width: 100px; max-width: 120px; aspect-ratio: 1/1.6; }
            .dish-img { height: 90px; }
            .dish-title, .dish-price { font-size: 1rem; }
        }

        /* Hi·ªáu ·ª©ng √¢m thanh */
        .audio-controls {
            display: inline-flex;
            gap: 5px;
            margin-left: 10px;
            vertical-align: middle;
        }
        
        .audio-controls .btn {
            padding: 2px 6px;
            font-size: 12px;
            border-radius: 4px;
        }
        
        .speaking-pulse {
            animation: speaking-pulse 1s infinite;
        }
        
        .auto-speak-toggle {
            position: absolute;
            top: 15px;
            right: 20px;
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            font-size: 14px;
        }
        
        .auto-speak-toggle label {
            margin: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .auto-speak-toggle input[type="checkbox"] {
            margin: 0;
        }
        
        @keyframes speaking-pulse {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
            }
            50% { 
                transform: scale(1.02);
                box-shadow: 0 0 15px rgba(0, 123, 255, 0.6);
            }
        }

        /* Hi·ªáu ·ª©ng microphone */
        .mic-btn {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .mic-btn.active {
            background: linear-gradient(45deg, #007bff, #00c6ff);
            color: white;
            transform: scale(1.05);
            box-shadow: 0 4px 20px rgba(0, 123, 255, 0.4);
        }
        .mic-btn.recording {
            background: linear-gradient(45deg, #dc3545, #ff6b6b);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(220, 53, 69, 0.5);
            animation: recording-pulse 1.5s infinite;
        }
        .mic-btn.recording::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(0);
            animation: ripple 1.5s infinite;
        }

        /* Hi·ªáu ·ª©ng s√≥ng √¢m */
        .audio-waves {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 120px;
            height: 120px;
            pointer-events: none;
        }
        .mic-btn.recording .audio-waves {
            display: block;
        }
        .wave {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 100%;
            height: 100%;
            border: 2px solid rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: wave 2s infinite;
        }
        .wave:nth-child(2) {
            animation-delay: 0.5s;
        }
        .wave:nth-child(3) {
            animation-delay: 1s;
        }

        /* Hi·ªáu ·ª©ng ch·ªù n√≥i */
        .listening-indicator {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            color: white;
            padding: 40px;
            border-radius: 25px;
            text-align: center;
            z-index: 10001;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            min-width: 280px;
        }
        .listening-indicator.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        .listening-indicator .mic-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: listening-pulse 2s infinite;
        }
        .listening-indicator .text {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .listening-indicator .subtext {
            font-size: 1rem;
            color: #ccc;
            margin-bottom: 25px;
        }
        .listening-indicator .volume-bars {
            display: flex;
            justify-content: center;
            gap: 4px;
            height: 40px;
            align-items: flex-end;
        }
        .listening-indicator .bar {
            width: 6px;
            background: linear-gradient(to top, #007bff, #00c6ff);
            border-radius: 3px;
            animation: volume-animation 1.5s infinite ease-in-out;
        }
        .listening-indicator .bar:nth-child(1) { animation-delay: 0s; }
        .listening-indicator .bar:nth-child(2) { animation-delay: 0.1s; }
        .listening-indicator .bar:nth-child(3) { animation-delay: 0.2s; }
        .listening-indicator .bar:nth-child(4) { animation-delay: 0.3s; }
        .listening-indicator .bar:nth-child(5) { animation-delay: 0.4s; }

        /* Animations */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        @keyframes recording-pulse {
            0%, 100% { transform: scale(1.1); }
            50% { transform: scale(1.15); }
        }
        @keyframes ripple {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
        }
        @keyframes wave {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
        }
        @keyframes listening-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        @keyframes volume-animation {
            0%, 100% { height: 10px; }
            50% { height: 40px; }
        }

        /* C·∫£i thi·ªán input group */
        .input-group .form-control {
            border-radius: 20px 0 0 20px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        .input-group .form-control:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        .input-group .btn {
            border-radius: 0 20px 20px 0;
            border: 2px solid #007bff;
            transition: all 0.3s ease;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
        }
        .btn:active {
            transform: translateY(0);
        }
    </style>
</head>
<body>
<div class="menu-header">
    <h1>Menu Nh√† H√†ng</h1>
    <div class="desc" id="tableInfo">Ch·ªçn m√≥n, tick v√†o m√≥n ƒë·ªÉ ch·ªçn v√† nh·∫•n "G·ª≠i order"!</div>
    <div class="auto-speak-toggle">
        <label class="form-check-label">
            <input type="checkbox" class="form-check-input" id="auto-speak-toggle" checked>
            <i class="fas fa-volume-up"></i> T·ª± ƒë·ªông ƒë·ªçc
        </label>
    </div>
</div>
<div class="container-fluid px-2">
    <div class="row mb-3 align-items-end gx-1 sticky-filter">
        <div class="col-6">
            <select class="form-select" id="sort-select">
                <option value="">S·∫Øp x·∫øp</option>
                <option value="price-asc">Gi√° tƒÉng d·∫ßn</option>
                <option value="price-desc">Gi√° gi·∫£m d·∫ßn</option>
                <option value="featured">N·ªïi b·∫≠t</option>
                <option value="new">M·ªõi</option>
            </select>
        </div>
        <div class="col-6">
            <div class="input-group">
                <input type="text" class="form-control" id="search-input" placeholder="üîç T√¨m m√≥n...">
                <button class="btn btn-secondary mic-btn" type="button" id="mic-btn">
                    <i class="fas fa-microphone"></i>
                    <div class="audio-waves">
                        <div class="wave"></div>
                        <div class="wave"></div>
                        <div class="wave"></div>
                    </div>
                </button>
            </div>
        </div>
    </div>
    <!-- Tabs lo·∫°i m√≥n -->
    <div id="dish-type-tabs" class="scrolling-tabs" style="overflow-x:auto;white-space:nowrap;padding:0 0 8px 0;margin-bottom:8px;">
        <!-- Tab buttons s·∫Ω ƒë∆∞·ª£c render b·∫±ng JS -->
    </div>
    <div class="row" id="dish-list"></div>
    <button class="btn btn-primary order-btn" id="order-btn">G·ª≠i order</button>
</div>

<!-- Indicator ch·ªù n√≥i -->
<div class="listening-indicator" id="listening-indicator">
    <div class="mic-icon">üé§</div>
    <div class="text">ƒêang l·∫Øng nghe...</div>
    <div class="subtext">H√£y n√≥i r√µ r√†ng v√†o microphone</div>
    <div class="volume-bars">
        <div class="bar"></div>
        <div class="bar"></div>
        <div class="bar"></div>
        <div class="bar"></div>
        <div class="bar"></div>
    </div>
</div>

<!-- Thanh taskbar d∆∞·ªõi c√πng -->
<div id="mobile-taskbar" style="position:fixed;bottom:0;left:0;width:100vw;height:62px;background:#fff;border-radius:18px 18px 0 0;box-shadow:0 -2px 16px #007bff22;z-index:10000;display:flex;align-items:center;justify-content:space-between;padding:0 18px 0 18px;gap:10px;">
    <button class="btn btn-primary" id="taskbar-order-btn" style="height:44px;min-width:110px;font-size:1.05rem;border-radius:16px;box-shadow:0 2px 8px #007bff22;">G·ª≠i order</button>
    <div style="display:flex;gap:12px;">
        <button id="taskbar-staff-btn" style="background:#fff;color:#007bff;border:none;border-radius:50%;width:44px;height:44px;box-shadow:0 2px 8px #e83e8c22;font-size:1.5rem;display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative;">
            <i class="fa-solid fa-user-large"></i>
        </button>
        <button id="taskbar-cart-btn" style="background:#fff;color:#007bff;border:none;border-radius:50%;width:44px;height:44px;box-shadow:0 2px 8px #0003;font-size:1.5rem;display:flex;align-items:center;justify-content:center;cursor:pointer;">
            <i class="fas fa-shopping-cart"></i>
        </button>
        <button id="taskbar-chatbot-btn" style="background:#007bff;color:#fff;border:none;border-radius:50%;width:48px;height:48px;box-shadow:0 2px 8px #0003;font-size:1.7rem;display:flex;align-items:center;justify-content:center;cursor:pointer;">
            <i class="fas fa-comments"></i>
        </button>
    </div>
</div>
<!-- ·∫®n c√°c n√∫t n·ªïi c≈© v√† n√∫t order c≈© -->
<style>
#open-cart-btn, #open-chatbot-btn, #order-btn { display: none !important; }
body { padding-bottom: 80px; }
.qty-group {
    display: flex !important;
    align-items: center;
    justify-content: center;
    gap: 10px;
    margin-top: 4px;
    visibility: visible !important;
    opacity: 1 !important;
    height: auto !important;
}
.qty-btn, .qty-input {
    display: inline-block !important;
    visibility: visible !important;
    opacity: 1 !important;
}
#taskbar-staff-btn:active {
    background: #ffe6f0;
    box-shadow: 0 2px 8px #e83e8c44;
}
#staff-btn-badge {
    transition: transform 0.2s;
}
#staff-btn-badge[style*="display: block"] {
    transform: scale(1.2);
}
</style>
<!-- Modal chatbot -->
<div class="modal fade" id="chatbotModal" tabindex="-1" aria-labelledby="chatbotModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-fullscreen m-0" style="max-width:100vw;width:100vw;height:100vh;">
    <div class="modal-content p-0 border-0 shadow-none" style="border-radius:0;overflow:hidden;min-width:100vw;min-height:100vh;background:#fff;">
      <div class="modal-header p-2 border-0" style="background:transparent;position:absolute;top:0;right:0;z-index:10;width:100vw;display:flex;justify-content:flex-end;align-items:flex-start;">
        <button type="button" class="btn btn-light btn-lg d-flex align-items-center justify-content-center" data-bs-dismiss="modal" aria-label="Close" style="font-size:1.5rem;border-radius:50%;width:36px;height:36px;box-shadow:0 2px 8px #0002;display:flex;align-items:center;justify-content:center;"><i class="fas fa-times"></i></button>
      </div>
      <div class="modal-body p-0" style="background:transparent;height:100vh;width:100vw;overflow:hidden;">
        <iframe id="chatbot-iframe" src="/chatbot-popup" style="width:100vw;height:100vh;border:none;background:transparent;display:block;"></iframe>
      </div>
    </div>
  </div>
</div>
<!-- Icon gi·ªè h√†ng g√≥c ph·∫£i tr√™n -->
<button id="open-cart-btn" style="position:fixed;top:18px;right:18px;z-index:9999;background:#fff;color:#007bff;border:none;border-radius:50%;width:48px;height:48px;box-shadow:0 2px 8px #0003;font-size:1.7rem;display:flex;align-items:center;justify-content:center;cursor:pointer;">
    <i class="fas fa-shopping-cart"></i>
</button>
<!-- Modal gi·ªè h√†ng -->
<div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius:18px;overflow:hidden;min-width:90vw;">
      <div class="modal-header">
        <h5 class="modal-title" id="cartModalLabel">Gi·ªè h√†ng c·ªßa b·∫°n</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-0" id="cart-body"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
      </div>
    </div>
  </div>
</div>
<!-- Modal QR chuy·ªÉn kho·∫£n -->
<div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius:18px;overflow:hidden;min-width:90vw;">
      <div class="modal-header">
        <h5 class="modal-title" id="qrModalLabel">Thanh to√°n chuy·ªÉn kho·∫£n</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="qr-modal-body">
        <div class="text-center text-muted">ƒêang l·∫•y m√£ QR...</div>
      </div>
    </div>
  </div>
</div>
<script>
// --- Copy to√†n b·ªô JS t·ª´ menu.html sang mobile_menu.html ƒë·ªÉ m·ªçi ch·ª©c nƒÉng ho·∫°t ƒë·ªông ---
// L·∫•y danh s√°ch m√≥n ƒÉn t·ª´ API
async function fetchDishes() {
    const res = await fetch('/api/dishes');
    return await res.json();
}
let allDishes = [];
let currentType = 'T·∫•t c·∫£';
let currentMeal = 'T·∫•t c·∫£';
let currentRegion = 'T·∫•t c·∫£';
let searchKeyword = '';
let currentSort = '';
let lastDishesJson = '';
function renderDropdowns() {} // Mobile kh√¥ng d√πng dropdown n√¢ng cao
function getAllTypes(dishes) {
    const types = new Set();
    dishes.forEach(d => { if (d.type) types.add(d.type); });
    return Array.from(types);
}
function renderTypeTabs(dishes) {
    const types = getAllTypes(dishes);
    const tabBar = document.getElementById('dish-type-tabs');
    let html = `<button class="btn btn-sm${currentType==='T·∫•t c·∫£'?' btn-primary':' btn-outline-primary'} mx-1 mb-1" onclick="selectTypeTab('T·∫•t c·∫£')">T·∫•t c·∫£</button>`;
    types.forEach(type => {
        html += `<button class="btn btn-sm${currentType===type?' btn-primary':' btn-outline-primary'} mx-1 mb-1" onclick="selectTypeTab('${type.replace(/'/g, '\&#39;')}')">${type}</button>`;
    });
    tabBar.innerHTML = html;
}
function selectTypeTab(type) {
    currentType = type;
    renderTypeTabs(allDishes);
    renderDishes(allDishes);
}
function renderDishes(dishes) {
    const dishList = document.getElementById('dish-list');
    dishList.innerHTML = '';
    let filtered = dishes;
    if (currentType && currentType !== 'T·∫•t c·∫£') {
        filtered = filtered.filter(d => d.dish_type === currentType);
    }
    if (searchKeyword) {
        filtered = filtered.filter(d => d.name.toLowerCase().includes(searchKeyword) || (d.description && d.description.toLowerCase().includes(searchKeyword)));
    }
    if (currentSort === 'price-asc') {
        filtered = filtered.slice().sort((a, b) => (a.price || 0) - (b.price || 0));
    } else if (currentSort === 'price-desc') {
        filtered = filtered.slice().sort((a, b) => (b.price || 0) - (a.price || 0));
    } else if (currentSort === 'featured') {
        filtered = filtered.slice().sort((a, b) => (b.price || 0) - (a.price || 0)).slice(0, 8);
    } else if (currentSort === 'new') {
        filtered = filtered.slice().sort((a, b) => b.name.localeCompare(a.name)).slice(0, 8);
    }
    if (!filtered.length) {
        dishList.innerHTML = '<div class="text-center text-muted py-5">Kh√¥ng t√¨m th·∫•y m√≥n n√†o ph√π h·ª£p.</div>';
        window._currentRenderedDishes = [];
        return;
    }
    window._currentRenderedDishes = filtered;
    // T·∫°o grid
    const grid = document.createElement('div');
    grid.className = 'dish-grid';
    filtered.forEach((dish, idx) => {
        let tagHtml = '';
        if (dish.status === false) {
            tagHtml += '<span class="badge bg-danger position-absolute top-50 start-50 translate-middle">T·∫°m h·∫øt m√≥n</span>';
        }
        const card = document.createElement('div');
        card.className = 'dish-card position-relative' + (dish.status === false ? ' opacity-50' : '');
        card.setAttribute('data-idx', idx);
        card.onclick = function() { toggleSelectDish(idx); };
        card.innerHTML = `
            ${tagHtml}
            <img class="dish-img" src="${dish.image || 'https://via.placeholder.com/400x160?text=No+Image'}" alt="${dish.name}">
            <div class="dish-info">
                <div class="dish-title">${dish.name}</div>
                <div class="dish-price">${dish.price ? dish.price.toLocaleString() + ' ƒë' : ''}</div>
                <div class="qty-group">
                    <button class="qty-btn" type="button" onclick="event.stopPropagation(); changeQty(${idx}, -1)" ${dish.status === false ? 'disabled' : ''}>-</button>
                    <input class="qty-input" type="number" min="1" value="1" id="qty-${idx}" ${dish.status === false ? 'disabled' : ''} onclick="event.stopPropagation();">
                    <button class="qty-btn" type="button" onclick="event.stopPropagation(); changeQty(${idx}, 1)" ${dish.status === false ? 'disabled' : ''}>+</button>
                </div>
            </div>
        `;
        grid.appendChild(card);
    });
    // ƒê√°nh d·∫•u card ƒë√£ ch·ªçn
    (window._selectedDishesIdxs || []).forEach(idx => {
        const card = grid.querySelector(`.dish-card[data-idx='${idx}']`);
        if (card) card.classList.add('selected');
    });
    dishList.appendChild(grid);
}
function changeQty(idx, delta) {
    const input = document.getElementById('qty-' + idx);
    if (!input) return;
    let val = parseInt(input.value) || 1;
    val += delta;
    if (val < 1) val = 1;
    input.value = val;
}
document.getElementById('search-input').addEventListener('input', function(e) {
    searchKeyword = e.target.value.trim().toLowerCase();
    renderDishes(allDishes);
});
document.getElementById('sort-select').addEventListener('change', function(e) {
    currentSort = e.target.value;
    renderDishes(allDishes);
});
document.addEventListener('DOMContentLoaded', async () => {
    const dishes = await fetchDishes();
    allDishes = dishes;
    renderTypeTabs(dishes);
    renderDishes(dishes);
    lastDishesJson = JSON.stringify(dishes);
    setInterval(async () => {
        const dishes = await fetchDishes();
        const newJson = JSON.stringify(dishes);
        if (newJson !== lastDishesJson) {
            allDishes = dishes;
            renderTypeTabs(dishes);
            renderDishes(dishes);
            lastDishesJson = newJson;
        }
    }, 1000);

    // Hi·ªÉn th·ªã tip v·ªÅ t√≠nh nƒÉng microphone sau 2 gi√¢y
    setTimeout(() => {
        if (micBtn && micBtn.style.display !== 'none') {
            const tipDiv = document.createElement('div');
            tipDiv.className = 'alert alert-info alert-dismissible fade show';
            tipDiv.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 10002; max-width: 90vw; text-align: center;';
            tipDiv.innerHTML = `
                üí° <strong>M·∫πo s·ª≠ d·ª•ng:</strong> B·∫°n c√≥ th·ªÉ nh·∫•n n√∫t microphone üé§ ƒë·ªÉ t√¨m ki·∫øm m√≥n ƒÉn b·∫±ng gi·ªçng n√≥i.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.body.appendChild(tipDiv);
            
            // T·ª± ƒë·ªông ·∫©n sau 8 gi√¢y
            setTimeout(() => {
                if (tipDiv.parentNode) {
                    tipDiv.remove();
                }
            }, 8000);
        }
    }, 2000);
});
window._selectedDishesIdxs = [];
function toggleSelectDish(idx) {
    if (window._currentRenderedDishes[idx].status === false) return;
    const i = window._selectedDishesIdxs.indexOf(idx);
    if (i === -1) window._selectedDishesIdxs.push(idx);
    else window._selectedDishesIdxs.splice(i, 1);
    renderDishes(allDishes);
    updateOrderBtnPosition();
}
// L·∫•y table_id ho·∫∑c table_name t·ª´ URL v√† l∆∞u v√†o localStorage
function getTableIdFromUrl() {
    const params = new URLSearchParams(window.location.search);
    return params.get('table_id') || params.get('table_name');
}
const tableId = getTableIdFromUrl();
if (tableId) {
    localStorage.setItem('table_id', tableId);
}
function getTableId() {
    // ∆Øu ti√™n table_id ho·∫∑c table_name t·ª´ URL parameter, sau ƒë√≥ m·ªõi t·ª´ localStorage
    const urlParams = new URLSearchParams(window.location.search);
    const urlTableId = urlParams.get('table_id') || urlParams.get('table_name');
    if (urlTableId) {
        return urlTableId;
    }
    return localStorage.getItem('table_id') || '';
}
// G·ª≠i order
document.getElementById('order-btn').onclick = async function() {
    const selected = [];
    (window._selectedDishesIdxs || []).forEach(idx => {
        const dish = window._currentRenderedDishes[idx];
        const qty = document.getElementById('qty-' + idx) ? parseInt(document.getElementById('qty-' + idx).value) || 1 : 1;
        selected.push({ name: dish.name, quantity: qty });
    });
    if (selected.length === 0) {
        alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt m√≥n!');
        return;
    }
    const res = await fetch('/api/order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items: selected, table_id: getTableId() })
    });
    if (res.ok) {
        alert('ƒê√£ th√™m v√†o h√≥a ƒë∆°n! B·∫°n c√≥ th·ªÉ m·ªü chatbot ƒë·ªÉ chat ho·∫∑c xem h√≥a ƒë∆°n.');
        window._selectedDishesIdxs = [];
        renderDishes(allDishes);
    } else {
        alert('C√≥ l·ªói khi g·ª≠i order!');
    }
};
document.getElementById('chatbotModal').addEventListener('hidden.bs.modal', function () {
    updateOrderBtnPosition(); // Hi·ªán l·∫°i n√∫t n·∫øu c√≥ m√≥n ƒë∆∞·ª£c ch·ªçn
});
let cartPollingInterval = null;
document.getElementById('open-cart-btn').onclick = async function() {
    await loadAndShowCartModal();
};
async function loadAndShowCartModal() {
    const res = await fetch('/api/cart', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ table_id: getTableId() })
    });
    const data = await res.json();
    renderCart(data);
    var modal = new bootstrap.Modal(document.getElementById('cartModal'));
    modal.show();
    if (cartPollingInterval) clearInterval(cartPollingInterval);
    cartPollingInterval = setInterval(async () => {
        if (!document.getElementById('cartModal').classList.contains('show')) {
            clearInterval(cartPollingInterval);
            cartPollingInterval = null;
            return;
        }
        const res = await fetch('/api/cart', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ table_id: getTableId() })
        });
        const data = await res.json();
        renderCart(data);
    }, 3000);
}
document.getElementById('cartModal').addEventListener('hidden.bs.modal', function () {
    if (cartPollingInterval) clearInterval(cartPollingInterval);
    cartPollingInterval = null;
});
let lastOrderStatusMap = {};
function renderCart(cartData) {
    if (document.activeElement && document.activeElement.classList.contains('note-input-focus')) {
        return;
    }
    const cartBody = document.getElementById('cart-body');
    const orders = cartData.orders || [];
    let qrJustPaid = false;
    orders.forEach(cart => {
        const prevStatus = lastOrderStatusMap[cart.order_id];
        if ((cart.status === 'paid' || cart.status === 'ƒê√£ thanh to√°n') && prevStatus && prevStatus !== 'paid' && prevStatus !== 'ƒê√£ thanh to√°n') {
            const qrModal = document.getElementById('qrModal');
            if (qrModal) {
                const isOpen = qrModal.classList.contains('show') || qrModal.getAttribute('aria-modal') === 'true' || qrModal.style.display === 'block';
                if (isOpen) {
                    let modal = bootstrap.Modal.getInstance(qrModal);
                    if (!modal) modal = new bootstrap.Modal(qrModal);
                    modal.hide();
                    qrJustPaid = true;
                }
            }
        }
    });
    orders.forEach(cart => {
        lastOrderStatusMap[cart.order_id] = cart.status;
    });
    if (!orders.length) {
        cartBody.innerHTML = '<div class="p-4 text-center text-muted">B·∫°n ch∆∞a c√≥ h√≥a ƒë∆°n n√†o.</div>';
        return;
    }
    let html = '';
    let totalAll = 0;
    orders.forEach((cart, idx) => {
        html += `<div class='card mb-4 shadow-sm'>`;
        html += `<div class='card-header d-flex justify-content-between align-items-center'>`;
        html += `<span><b>H√≥a ƒë∆°n #${idx + 1}</b> (${cart.created_at || ''})</span>`;
        html += `<span class='badge bg-${getStatusColor(cart.status)}'>${getStatusText(cart.status)}</span>`;
        html += `</div><div class='card-body p-0'>`;
        html += '<table class="table table-bordered mb-0"><thead><tr><th>M√≥n</th><th>SL</th><th>Gi√°</th><th>Th√†nh ti·ªÅn</th><th>Ghi ch√∫</th><th></th></tr></thead><tbody>';
        cart.items.forEach(item => {
            html += `<tr><td>${item.dish}</td><td>${item.quantity}</td><td>${item.unit_price ? item.unit_price.toLocaleString() + ' ƒë' : ''}</td><td><b>${item.amount.toLocaleString()} ƒë</b></td>`;
            html += '<td>';
            if (!cart.status || cart.status === 'pending') {
                html += `<input type='text' class='form-control form-control-sm note-input-focus' style='min-width:90px;max-width:180px;display:inline-block' value="${item.note ? item.note.replace(/"/g, '&quot;') : ''}" onfocus="this.classList.add('note-input-focus')" onblur="this.classList.remove('note-input-focus'); updateNote('${cart.order_id}','${item.dish.replace(/'/g, '\&#39;').replace(/"/g, '&quot;')}', this.value)" placeholder='Ghi ch√∫...'>`;
            } else {
                html += `<span>${item.note || ''}</span>`;
            }
            html += '</td>';
            html += '<td>';
            if (!cart.status || cart.status === 'pending') {
                html += `<button class='btn btn-sm btn-danger' onclick='removeCartItem("${cart.order_id}", "${item.dish.replace(/"/g, '&quot;')}")'><i class="fas fa-trash"></i></button>`;
            }
            html += `</td></tr>`;
        });
        html += '</tbody></table>';
        html += `<div class="p-3 text-end"><b>T·ªïng c·ªông: ${cart.total ? cart.total.toLocaleString() : 0} ƒë</b></div>`;
        totalAll += cart.total || 0;
        if (cart.status === 'confirmed') {
            html += `<div class='alert alert-success m-3 text-center'>ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c g·ª≠i cho nh√† h√†ng. ƒêang ch·ªù b·∫øp x√°c nh·∫≠n!</div>`;
            html += `<div class='text-center mb-3'><button class='btn btn-success' disabled>ƒê√£ g·ª≠i nh√† h√†ng</button></div>`;
        } else if (cart.status === 'in_progress') {
            html += `<div class='alert alert-info m-3 text-center'>Nh√† h√†ng ƒë√£ x√°c nh·∫≠n m√≥n ƒÉn, b·∫°n ch·ªù trong gi√¢y l√°t nh√©!</div>`;
            html += `<div class='text-center mb-3'><button class='btn btn-info' disabled>ƒêang l√†m m√≥n</button></div>`;
        } else if (cart.status === 'done') {
            html += `<div class='alert alert-primary m-3 text-center'>M√≥n ƒÉn ƒë√£ ho√†n th√†nh! Ch√∫c b·∫°n ngon mi·ªáng.</div>`;
            html += `<div class='text-center mb-3'><button class='btn btn-primary' disabled>ƒê√£ xong</button></div>`;
        } else if (cart.status === 'paid' || cart.status === 'ƒê√£ thanh to√°n') {
            html += `<div class='alert alert-success m-3 text-center'><b>Nh√† h√†ng ƒë√£ x√°c nh·∫≠n chuy·ªÉn kho·∫£n th√†nh c√¥ng! C·∫£m ∆°n b·∫°n.</b></div>`;
            html += `<div class='text-center mb-3'><button class='btn btn-success' disabled>ƒê√£ thanh to√°n</button></div>`;
        } else {
            html += `<div class='text-center mb-3'><button class='btn btn-success' onclick='confirmCart("${cart.order_id}")'>X√°c nh·∫≠n g·ª≠i m√≥n cho nh√† h√†ng</button></div>`;
        }
        html += `</div></div>`;
    });
    html += `<div class="alert alert-info text-end mb-0"><b>üí∞ T·ªïng h√≥a ƒë∆°n (t·∫•t c·∫£): ${totalAll.toLocaleString()} ƒë</b></div>`;
    cartBody.innerHTML = html;
    if (qrJustPaid) {
        setTimeout(() => { alert('Nh√† h√†ng ƒë√£ x√°c nh·∫≠n chuy·ªÉn kho·∫£n th√†nh c√¥ng!'); }, 300);
    }
}function getStatusColor(status) {
    if (status === 'confirmed') return 'success';
    if (status === 'in_progress') return 'info';
    if (status === 'done') return 'primary';
    if (status === 'paid' || status === 'ƒê√£ thanh to√°n') return 'danger';
    return 'secondary';
}function getStatusText(status) {
    if (status === 'confirmed') return 'ƒê√£ g·ª≠i b·∫øp';
    if (status === 'in_progress') return 'ƒêang l√†m';
    if (status === 'done') return 'ƒê√£ xong';
    if (status === 'paid' || status === 'ƒê√£ thanh to√°n') return 'ƒê√£ thanh to√°n';
    return 'Ch∆∞a ch·ªët';
}
async function removeCartItem(orderId, dishName) {
    if (!confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a m√≥n n√†y kh·ªèi h√≥a ƒë∆°n?')) return;
    const res = await fetch('/api/cart/remove_item', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ dish_name: dishName, order_id: orderId, table_id: getTableId() })
    });
    if (res.ok) {
        const cartRes = await fetch('/api/cart', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ table_id: getTableId() })
        });
        const cartData = await cartRes.json();
        renderCart(cartData);
    } else {
        alert('C√≥ l·ªói khi x√≥a m√≥n!');
    }
}
async function confirmCart(orderId) {
    if (!confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën g·ª≠i ƒë∆°n n√†y cho nh√† h√†ng? Sau khi x√°c nh·∫≠n s·∫Ω kh√¥ng th·ªÉ s·ª≠a/x√≥a m√≥n!')) return;
    const res = await fetch('/api/cart/confirm', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ order_id: orderId, table_id: getTableId() })
    });
    if (res.ok) {
        alert('ƒê√£ g·ª≠i ƒë∆°n cho nh√† h√†ng!');
        const cartRes = await fetch('/api/cart', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ table_id: getTableId() })
        });
        const cartData = await cartRes.json();
        renderCart(cartData);
    } else {
        alert('C√≥ l·ªói khi x√°c nh·∫≠n ƒë∆°n!');
    }
}
async function updateNote(orderId, dishName, note) {
    const res = await fetch('/api/cart/update_note', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ order_id: orderId, dish_name: dishName, note: note, table_id: getTableId() })
    });
    if (!res.ok) {
        alert('C√≥ l·ªói khi l∆∞u ghi ch√∫!');
    }
}
(function addPayQRButton() {
    const cartModalFooter = document.querySelector('#cartModal .modal-footer');
    if (cartModalFooter && !document.getElementById('pay-qr-btn')) {
        const btn = document.createElement('button');
        btn.className = 'btn btn-warning';
        btn.id = 'pay-qr-btn';
        btn.innerHTML = '<i class="fas fa-qrcode"></i> Thanh to√°n chuy·ªÉn kho·∫£n';
        btn.onclick = showQRModal;
        cartModalFooter.insertBefore(btn, cartModalFooter.firstChild);
    }
})();
async function showQRModal() {
    const qrBody = document.getElementById('qr-modal-body');
    qrBody.innerHTML = '<div class="text-center text-muted">ƒêang l·∫•y m√£ QR...</div>';
    var modal = new bootstrap.Modal(document.getElementById('qrModal'));
    modal.show();
    try {
        const res = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: 'chuy·ªÉn kho·∫£n' })
        });
        const data = await res.json();
        qrBody.innerHTML = data.response || '<div class="text-danger">Kh√¥ng l·∫•y ƒë∆∞·ª£c m√£ QR!</div>';
        // Th√™m n√∫t t·∫£i QR n·∫øu c√≥ ·∫£nh QR
        setTimeout(() => {
            const img = qrBody.querySelector('img');
            if (img) {
                // T·∫°o container flex cho ·∫£nh v√† n√∫t
                let flexDiv = document.createElement('div');
                flexDiv.style.display = 'flex';
                flexDiv.style.alignItems = 'center';
                flexDiv.style.justifyContent = 'center';
                flexDiv.style.gap = '16px';
                // Di chuy·ªÉn ·∫£nh v√†o container
                img.parentNode.insertBefore(flexDiv, img);
                flexDiv.appendChild(img);
                // T·∫°o n√∫t t·∫£i
                let downloadBtn = document.createElement('button');
                downloadBtn.className = 'btn btn-outline-primary';
                downloadBtn.innerHTML = '<i class="fas fa-download"></i> T·∫£i m√£ QR';
                downloadBtn.onclick = async function() {
                    try {
                        const response = await fetch(img.src, {mode: 'cors'});
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = 'qr-code.png';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(url);
                    } catch (e) {
                        alert('Kh√¥ng th·ªÉ t·∫£i ·∫£nh QR. B·∫°n c√≥ th·ªÉ nh·∫•n gi·ªØ v√†o ·∫£nh ƒë·ªÉ l∆∞u v·ªÅ m√°y!');
                    }
                };
                flexDiv.appendChild(downloadBtn);
            }
        }, 100);
    } catch (e) {
        qrBody.innerHTML = '<div class="text-danger">C√≥ l·ªói khi l·∫•y m√£ QR!</div>';
    }
}
const style = document.createElement('style');
style.innerHTML = `
#order-btn.fixed-order-btn {
  position: fixed;
  left: 50%;
  bottom: 32px;
  transform: translateX(-50%);
  z-index: 9999;
  width: 90vw;
  max-width: 420px;
  box-shadow: 0 4px 24px #007bff33;
  display: block;
}
@media (max-width: 600px) {
  #order-btn.fixed-order-btn {
    width: 96vw;
    max-width: 98vw;
    font-size: 1.1rem;
    padding: 12px 0;
  }
}`;
document.head.appendChild(style);
function updateOrderBtnPosition() {
    const btn = document.getElementById('order-btn');
    const anyChecked = (window._selectedDishesIdxs || []).length > 0;
    if (anyChecked) {
        btn.classList.add('fixed-order-btn');
        btn.style.display = 'block';
    } else {
        btn.classList.remove('fixed-order-btn');
        btn.style.display = '';
    }
}
const origRenderDishes = renderDishes;
renderDishes = function() {
    origRenderDishes.apply(this, arguments);
    setTimeout(() => {
        document.querySelectorAll('.select-checkbox').forEach(cb => {
            cb.removeEventListener('change', updateOrderBtnPosition);
            cb.addEventListener('change', updateOrderBtnPosition);
        });
        updateOrderBtnPosition();
    }, 0);
};
document.getElementById('taskbar-cart-btn').onclick = async function() {
    await loadAndShowCartModal();
};
document.getElementById('taskbar-chatbot-btn').onclick = function() {
    var modal = new bootstrap.Modal(document.getElementById('chatbotModal'));
    modal.show();
    // ·∫®n taskbar khi m·ªü chatbot
    const mobileTaskbar = document.getElementById('mobile-taskbar');
    if (mobileTaskbar) mobileTaskbar.style.display = 'none';
};
document.getElementById('chatbotModal').addEventListener('hidden.bs.modal', function () {
    // Hi·ªán l·∫°i taskbar khi ƒë√≥ng chatbot
    const mobileTaskbar = document.getElementById('mobile-taskbar');
    if (mobileTaskbar) mobileTaskbar.style.display = 'flex';
});
document.getElementById('taskbar-order-btn').onclick = async function() {
    const selected = [];
    (window._selectedDishesIdxs || []).forEach(idx => {
        const dish = window._currentRenderedDishes[idx];
        const qty = document.getElementById('qty-' + idx) ? parseInt(document.getElementById('qty-' + idx).value) || 1 : 1;
        selected.push({ name: dish.name, quantity: qty });
    });
    if (selected.length === 0) {
        alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt m√≥n!');
        return;
    }
    const res = await fetch('/api/order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items: selected, table_id: getTableId() })
    });
    if (res.ok) {
        alert('ƒê√£ th√™m v√†o h√≥a ƒë∆°n! B·∫°n c√≥ th·ªÉ m·ªü chatbot ƒë·ªÉ chat ho·∫∑c xem h√≥a ƒë∆°n.');
        window._selectedDishesIdxs = [];
        renderDishes(allDishes);
    } else {
        alert('C√≥ l·ªói khi g·ª≠i order!');
    }
};
// ·∫®n/hi·ªán n√∫t order tr√™n taskbar tu·ª≥ m√≥n ƒë∆∞·ª£c ch·ªçn
function updateOrderBtnPosition() {
    const btn = document.getElementById('taskbar-order-btn');
    const anyChecked = (window._selectedDishesIdxs || []).length > 0;
    btn.style.visibility = anyChecked ? 'visible' : 'hidden';
}
// ·∫®n taskbar khi m·ªü gi·ªè h√†ng, hi·ªán l·∫°i khi ƒë√≥ng gi·ªè h√†ng
const mobileTaskbar = document.getElementById('mobile-taskbar');
document.getElementById('cartModal').addEventListener('show.bs.modal', function () {
    if (mobileTaskbar) mobileTaskbar.style.display = 'none';
});
document.getElementById('cartModal').addEventListener('hidden.bs.modal', function () {
    if (mobileTaskbar) mobileTaskbar.style.display = 'flex';
});
document.getElementById('taskbar-staff-btn').onclick = async function() {
    if (!confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën g·ªçi nh√¢n vi√™n kh√¥ng?')) return;
    const tableId = getTableId();
    const res = await fetch('/api/call_staff', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ table_id: tableId })
    });
    if (res.ok) {
        alert('ƒê√£ g·ª≠i y√™u c·∫ßu g·ªçi nh√¢n vi√™n! Nh√¢n vi√™n s·∫Ω ƒë·∫øn h·ªó tr·ª£ b·∫°n trong gi√¢y l√°t.');
    } else {
        alert('C√≥ l·ªói khi g·ª≠i y√™u c·∫ßu g·ªçi nh√¢n vi√™n!');
    }
};

// --- Ch·ª©c nƒÉng Microphone ---
let recognizing = false;
let recognition;
const micBtn = document.getElementById('mic-btn');
const listeningIndicator = document.getElementById('listening-indicator');
const searchInput = document.getElementById('search-input');

function showListeningIndicator() {
    listeningIndicator.classList.add('show');
}

function hideListeningIndicator() {
    listeningIndicator.classList.remove('show');
}

function updateMicState(state) {
    micBtn.classList.remove('active', 'recording');
    if (state === 'listening') {
        micBtn.classList.add('active');
    } else if (state === 'recording') {
        micBtn.classList.add('recording');
    }
}

// Kh·ªüi t·∫°o Web Speech API
if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition();
    recognition.lang = 'vi-VN';
    recognition.continuous = false;
    recognition.interimResults = true;

    recognition.onstart = function() {
        recognizing = true;
        updateMicState('recording');
        showListeningIndicator();
        console.log('B·∫Øt ƒë·∫ßu nh·∫≠n di·ªán gi·ªçng n√≥i...');
    };

    recognition.onend = function() {
        recognizing = false;
        updateMicState('idle');
        hideListeningIndicator();
        console.log('K·∫øt th√∫c nh·∫≠n di·ªán gi·ªçng n√≥i.');
    };

    recognition.onresult = function(event) {
        let finalTranscript = '';
        let interimTranscript = '';

        for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            if (event.results[i].isFinal) {
                finalTranscript += transcript;
            } else {
                interimTranscript += transcript;
            }
        }

        if (finalTranscript) {
            searchInput.value = finalTranscript;
            searchInput.dispatchEvent(new Event('input'));
            console.log('K·∫øt qu·∫£ cu·ªëi c√πng:', finalTranscript);
        } else if (interimTranscript) {
            searchInput.value = interimTranscript;
            console.log('K·∫øt qu·∫£ t·∫°m th·ªùi:', interimTranscript);
        }
    };

    recognition.onerror = function(event) {
        console.error('L·ªói nh·∫≠n di·ªán gi·ªçng n√≥i:', event.error);
        let errorMessage = '';
        switch(event.error) {
            case 'no-speech':
                errorMessage = 'Kh√¥ng nghe th·∫•y gi·ªçng n√≥i. Vui l√≤ng n√≥i r√µ r√†ng h∆°n.';
                break;
            case 'audio-capture':
                errorMessage = 'Kh√¥ng th·ªÉ truy c·∫≠p microphone. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi.';
                break;
            case 'not-allowed':
                errorMessage = 'Quy·ªÅn truy c·∫≠p microphone b·ªã t·ª´ ch·ªëi. Vui l√≤ng c·∫•p quy·ªÅn trong tr√¨nh duy·ªát.';
                break;
            case 'network':
                errorMessage = 'L·ªói k·∫øt n·ªëi m·∫°ng. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi internet.';
                break;
            default:
                errorMessage = 'C√≥ l·ªói x·∫£y ra khi nh·∫≠n di·ªán gi·ªçng n√≥i. Vui l√≤ng th·ª≠ l·∫°i.';
        }
        alert(errorMessage);
    };

    recognition.onaudiostart = function() {
        console.log('B·∫Øt ƒë·∫ßu ghi √¢m...');
    };

    recognition.onaudioend = function() {
        console.log('K·∫øt th√∫c ghi √¢m.');
    };

    recognition.onsoundstart = function() {
        console.log('B·∫Øt ƒë·∫ßu ph√°t hi·ªán √¢m thanh...');
    };

    recognition.onsoundend = function() {
        console.log('K·∫øt th√∫c ph√°t hi·ªán √¢m thanh.');
    };

    recognition.onspeechstart = function() {
        console.log('B·∫Øt ƒë·∫ßu ph√°t hi·ªán gi·ªçng n√≥i...');
    };

    recognition.onspeechend = function() {
        console.log('K·∫øt th√∫c ph√°t hi·ªán gi·ªçng n√≥i.');
    };

    // X·ª≠ l√Ω s·ª± ki·ªán click microphone
    micBtn.onclick = function(e) {
        e.preventDefault();
        if (recognizing) {
            recognition.stop();
        } else {
            if (navigator.permissions) {
                navigator.permissions.query({name: 'microphone'}).then(function(result) {
                    if (result.state === 'granted' || result.state === 'prompt') {
                        recognition.start();
                    } else {
                        alert('‚ùå **Quy·ªÅn truy c·∫≠p microphone:** Vui l√≤ng c·∫•p quy·ªÅn truy c·∫≠p microphone ƒë·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng n√†y. B·∫°n c√≥ th·ªÉ nh·∫•n v√†o bi·ªÉu t∆∞·ª£ng kh√≥a trong thanh ƒë·ªãa ch·ªâ tr√¨nh duy·ªát.');
                    }
                });
            } else {
                recognition.start();
            }
        }
    };

    // Ph√≠m t·∫Øt: Space ƒë·ªÉ b·∫≠t/t·∫Øt microphone - ƒê√É T·∫ÆT
    // document.addEventListener('keydown', function(e) {
    //     if (e.code === 'Space' && e.target === searchInput && !e.shiftKey) {
    //         e.preventDefault();
    //         if (isRecording) {
    //             stopRecording();
    //         } else {
    //             startRecording();
    //         }
    //     }
    // });

} else {
    console.log('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Web Speech API');
    micBtn.style.display = 'none';
}

    // --- Ch·ª©c nƒÉng Text-to-Speech (Bot tr·∫£ l·ªùi b·∫±ng gi·ªçng n√≥i) ---
    let speechSynthesis = window.speechSynthesis;
    let speaking = false;
    let currentUtterance = null;

    // H√†m ƒë·ªÉ bot tr·∫£ l·ªùi b·∫±ng gi·ªçng n√≥i
    function speakText(text, lang = 'vi-VN') {
        if (speaking && currentUtterance) {
            speechSynthesis.cancel(); // D·ª´ng ph√°t √¢m hi·ªán t·∫°i
        }

        // L√†m s·∫°ch text tr∆∞·ªõc khi ƒë·ªçc (lo·∫°i b·ªè HTML tags n·∫øu c√≥)
        let cleanText = text;
        if (typeof text === 'string') {
            // Lo·∫°i b·ªè HTML tags
            cleanText = text.replace(/<[^>]+>/g, '');
            // Lo·∫°i b·ªè HTML entities
            cleanText = cleanText.replace(/&nbsp;/g, ' ')
                               .replace(/&amp;/g, '&')
                               .replace(/&lt;/g, '<')
                               .replace(/&gt;/g, '>')
                               .replace(/&quot;/g, '"')
                               .replace(/&#39;/g, "'");
            // Lo·∫°i b·ªè emojis v√† k√Ω t·ª± ƒë·∫∑c bi·ªát
            cleanText = cleanText.replace(/[\u{1F600}-\u{1F64F}]/gu, '') // Emoticons
                               .replace(/[\u{1F300}-\u{1F5FF}]/gu, '') // Misc Symbols
                               .replace(/[\u{1F680}-\u{1F6FF}]/gu, '') // Transport
                               .replace(/[\u{1F1E0}-\u{1F1FF}]/gu, '') // Regional
                               .replace(/[\u{1F900}-\u{1F9FF}]/gu, '') // Supplemental
                               .replace(/[\u{1FA70}-\u{1FAFF}]/gu, '') // Extended-A
                               .replace(/[‚Ä¢¬∑‚ñ™‚ñ´‚Ä£‚ÅÉ‚ó¶‚Ä£‚Åå‚Åç]/g, '') // Bullet points
                               .replace(/[‚Üí‚Üê‚Üë‚Üì‚áí‚áê‚áë‚áì]/g, '') // Arrows
                               .replace(/[‚òÖ‚òÜ‚ú≠‚úÆ‚úØ‚ú∞]/g, '') // Stars
                               .replace(/[‚ô•‚ô¶‚ô£‚ô†]/g, ''); // Card suits
            // Lo·∫°i b·ªè kho·∫£ng tr·∫Øng th·ª´a
            cleanText = cleanText.replace(/\s+/g, ' ').trim();
        }

        // T·∫°o utterance m·ªõi
        currentUtterance = new SpeechSynthesisUtterance(cleanText);
        currentUtterance.lang = lang;
        currentUtterance.rate = 0.9; // T·ªëc ƒë·ªô n√≥i (0.8-1.2)
        currentUtterance.pitch = 1.0; // Cao ƒë·ªô
        currentUtterance.volume = 1.0; // √Çm l∆∞·ª£ng

        // X·ª≠ l√Ω s·ª± ki·ªán
        currentUtterance.onstart = function() {
            speaking = true;
            console.log('B·∫Øt ƒë·∫ßu ph√°t √¢m:', cleanText);
        };

        currentUtterance.onend = function() {
            speaking = false;
            console.log('K·∫øt th√∫c ph√°t √¢m');
        };

        currentUtterance.onerror = function(event) {
            speaking = false;
            console.error('L·ªói ph√°t √¢m:', event.error);
        };

        // B·∫Øt ƒë·∫ßu ph√°t √¢m
        speechSynthesis.speak(currentUtterance);
    }

    // H√†m d·ª´ng ph√°t √¢m
    function stopSpeaking() {
        if (speaking && currentUtterance) {
            speechSynthesis.cancel();
            speaking = false;
        }
    }

    // T·ª± ƒë·ªông ph√°t √¢m tin nh·∫Øn bot m·ªõi (c√≥ th·ªÉ t·∫Øt/b·∫≠t)
    let autoSpeak = true; // M·∫∑c ƒë·ªãnh b·∫≠t

    // Kh√¥i ph·ª•c tr·∫°ng th√°i t·ª´ localStorage
    const savedAutoSpeak = localStorage.getItem('autoSpeak');
    if (savedAutoSpeak !== null) {
        autoSpeak = savedAutoSpeak === 'true';
        document.getElementById('auto-speak-toggle').checked = autoSpeak;
    }

    // X·ª≠ l√Ω s·ª± ki·ªán thay ƒë·ªïi checkbox
    document.getElementById('auto-speak-toggle').addEventListener('change', function() {
        autoSpeak = this.checked;
        localStorage.setItem('autoSpeak', autoSpeak);
    });

    // H√†m ƒë·ªÉ ƒë·ªçc th√¥ng b√°o khi c√≥ s·ª± ki·ªán quan tr·ªçng
    function speakNotification(message) {
        if (autoSpeak && message) {
            setTimeout(() => {
                speakText(message);
            }, 500);
        }
    }

    // Th√™m ph√≠m t·∫Øt ƒë·ªÉ d·ª´ng ph√°t √¢m (ph√≠m Escape)
    document.addEventListener('keydown', function(e) {
        if (e.code === 'Escape') {
            stopSpeaking();
        }
    });

    // ƒê·ªçc th√¥ng b√°o khi c√≥ s·ª± ki·ªán quan tr·ªçng
    // Khi ch·ªçn m√≥n ƒÉn
    function addDishSelectionNotification(dishName) {
        speakNotification(`ƒê√£ ch·ªçn ${dishName}`);
    }

    // Khi b·ªè ch·ªçn m√≥n ƒÉn
    function removeDishSelectionNotification(dishName) {
        speakNotification(`ƒê√£ b·ªè ch·ªçn ${dishName}`);
    }

    // Khi thay ƒë·ªïi s·ªë l∆∞·ª£ng
    function changeQuantityNotification(dishName, quantity) {
        speakNotification(`ƒê√£ thay ƒë·ªïi s·ªë l∆∞·ª£ng ${dishName} th√†nh ${quantity}`);
    }

    // ƒê·ªçc th√¥ng b√°o khi g·ª≠i order
    const orderBtn = document.getElementById('order-btn');
    if (orderBtn) {
        orderBtn.addEventListener('click', function() {
            speakNotification('ƒêang g·ª≠i ƒë∆°n h√†ng c·ªßa b·∫°n');
        });
    }

    // ƒê·ªçc th√¥ng b√°o khi g·ªçi nh√¢n vi√™n
    const staffBtn = document.getElementById('taskbar-staff-btn');
    if (staffBtn) {
        staffBtn.addEventListener('click', function() {
            speakNotification('ƒêang g·ªçi nh√¢n vi√™n ph·ª•c v·ª•');
        });
    }

    // ƒê·ªçc th√¥ng b√°o khi m·ªü gi·ªè h√†ng
    const cartBtn = document.getElementById('taskbar-cart-btn');
    if (cartBtn) {
        cartBtn.addEventListener('click', function() {
            speakNotification('M·ªü gi·ªè h√†ng');
        });
    }

    // ƒê·ªçc th√¥ng b√°o khi m·ªü chatbot
    const chatbotBtn = document.getElementById('taskbar-chatbot-btn');
    if (chatbotBtn) {
        chatbotBtn.addEventListener('click', function() {
            speakNotification('M·ªü chatbot h·ªó tr·ª£');
        });
    }

    // X·ª≠ l√Ω table_id ho·∫∑c table_name t·ª´ URL v√† c·∫≠p nh·∫≠t th√¥ng tin b√†n
    function handleTableInfo() {
        const urlParams = new URLSearchParams(window.location.search);
        const tableId = urlParams.get('table_id') || urlParams.get('table_name');
        
        if (tableId) {
            // C·∫≠p nh·∫≠t th√¥ng tin b√†n
            const tableInfoElement = document.getElementById('tableInfo');
            if (tableInfoElement) {
                tableInfoElement.innerHTML = `B√†n ${tableId} - Ch·ªçn m√≥n, tick v√†o m√≥n ƒë·ªÉ ch·ªçn v√† nh·∫•n "G·ª≠i order"!`;
            }
            
            // C·∫≠p nh·∫≠t user_id ƒë·ªÉ s·ª≠ d·ª•ng cho order
            window.currentTableId = tableId;
            
            // Th√¥ng b√°o ch√†o m·ª´ng theo b√†n
            setTimeout(() => {
                speakNotification(`Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi b√†n ${tableId}. B·∫°n c√≥ th·ªÉ ch·ªçn m√≥n ƒÉn v√† s·ª≠ d·ª•ng microphone ƒë·ªÉ t√¨m ki·∫øm m√≥n ƒÉn.`);
            }, 2000);
        } else {
            // N·∫øu kh√¥ng c√≥ table_id, s·ª≠ d·ª•ng th√¥ng b√°o m·∫∑c ƒë·ªãnh
            setTimeout(() => {
                speakNotification('Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi menu nh√† h√†ng. B·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng microphone ƒë·ªÉ t√¨m ki·∫øm m√≥n ƒÉn v√† t√¥i s·∫Ω ƒë·ªçc th√¥ng b√°o cho b·∫°n.');
            }, 2000);
        }
    }

    // G·ªçi h√†m x·ª≠ l√Ω th√¥ng tin b√†n khi trang load
    handleTableInfo();

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html> 

